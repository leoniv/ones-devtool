//**********************************************************************************
//  Доп. обработка "Имя_обработки"
//
//  Соответствует шаблону доп. обработок АСПЦ-1С
//  Поддрежка интеграции с подситемой "ДополнительныеОтчетыИОбработки" БСП v 2.2
//
//  Respect: авторам проекта V8Unpack https://www.assembla.com/wiki/show/V8Unpack/. 
//
//  Copyright © 2013 Leonid Vlasov (leo@asscode.ru)
//  copyright_sub  
//
//  Описание:  description_sub
//
//  Поддержка: email_sub
//             site_sub
//
//	Данная лицензия разрешает лицам, получившим копию данного программного 
//	обеспечения и сопутствующей документации (в дальнейшем именуемыми «Программное 
//	Обеспечение»), безвозмездно использовать Программное Обеспечение без ограничений, 
//	включая неограниченное право на использование, копирование, изменение, 
//	добавление, публикацию, распространение, сублицензирование и/или продажу копий 
//	Программного Обеспечения, также как и лицам, которым предоставляется данное 
//	Программное Обеспечение, при соблюдении следующих условий:
//
//	Указанное выше уведомление об авторском праве и данные условия должны быть 
//	включены во все копии или значимые части данного Программного Обеспечения.
//
//	ДАННОЕ ПРОГРАММНОЕ ОБЕСПЕЧЕНИЕ ПРЕДОСТАВЛЯЕТСЯ «КАК ЕСТЬ», БЕЗ КАКИХ-ЛИБО 
//	ГАРАНТИЙ, ЯВНО ВЫРАЖЕННЫХ ИЛИ ПОДРАЗУМЕВАЕМЫХ, ВКЛЮЧАЯ, НО НЕ ОГРАНИЧИВАЯСЬ 
//	ГАРАНТИЯМИ ТОВАРНОЙ ПРИГОДНОСТИ, СООТВЕТСТВИЯ ПО ЕГО КОНКРЕТНОМУ НАЗНАЧЕНИЮ И 
//	ОТСУТСТВИЯ НАРУШЕНИЙ ПРАВ. НИ В КАКОМ СЛУЧАЕ АВТОРЫ ИЛИ ПРАВООБЛАДАТЕЛИ НЕ НЕСУТ 
//	ОТВЕТСТВЕННОСТИ ПО ИСКАМ О ВОЗМЕЩЕНИИ УЩЕРБА, УБЫТКОВ ИЛИ ДРУГИХ ТРЕБОВАНИЙ ПО 
//	ДЕЙСТВУЮЩИМ КОНТРАКТАМ, ДЕЛИКТАМ ИЛИ ИНОМУ, ВОЗНИКШИМ ИЗ, ИМЕЮЩИМ ПРИЧИНОЙ ИЛИ 
//	СВЯЗАННЫМ С ПРОГРАММНЫМ ОБЕСПЕЧЕНИЕМ ИЛИ ИСПОЛЬЗОВАНИЕМ ПРОГРАММНОГО ОБЕСПЕЧЕНИЯ 
//	ИЛИ ИНЫМИ ДЕЙСТВИЯМИ С ПРОГРАММНЫМ ОБЕСПЕЧЕНИЕМ.
//
//***************************************************************************************
// ШАБЛОННЫЕ ПЕРЕМЕННЫЕ
Перем libs export;
// ПЕРЕМЕННЫЕ МОДУЛЯ

//{TODO ПЕРЕМЕННЫЕ МОДУЛЯ ПИШЕМ ЗДЕСЬ}

////////////////////////////////////////////////////
//ШАБЛОН АСПЦ-1С НАЧАЛО

//Идентификация объекта ***********************
function Name() Export
	return ЭтотОбъект.Метаданные().Имя;
endfunction	
//Номер версии - заполнять при ответвлении новой
//Номер имеет формат "0.0"
function Version() Export
	version="version_sub";
	return version;
endfunction
//Номер релиза - заполнять перед выпуском
//Монотонно возрастающее целое число
function Rel() export
	rel="rel_sub";
	return rel;
endfunction
//Имя пакета к которому пренадлежит объект
//имя пакета не должно содержать символов 
//запрещённых в именах фалов
//см. пакеты Java
function Package() export
	package="package_sub";
	Return package;	
endfunction	
//Реализует правила именовния файлов релизов объектов
//name.v1.v2.rel.epf (erf|cf)
function ObjFname(objname,objversion,objrel,ext) export
	return objname+"."+objversion+"."+objrel+"."+ext
endfunction	
//Подключение библиотек ***********************
//Возвращает текущий системный разделитель пути
function SysDelim()
	СИ = new СистемнаяИнформация;
	return ?(СИ.ТипПлатформы=ТипПлатформы.Windows_x86 ИЛИ СИ.ТипПлатформы=ТипПлатформы.Windows_x86_64,"\","/");
endfunction	
function SearchPath(Package)
	СИ=Новый СистемнаяИнформация;
	Если Найти(НРег(Строка(СИ.ТипПлатформы)),"windows") тогда
		SysDelim = "\";
		WSH=Новый COMobject("wscript.shell"); 
		SearchPath = WSH.ExpandEnvironmentStrings("%ASPCHome%");
		SearchPath=?(СтрЧислоВхождений(SearchPath,"%ASPCHome%")>0,"",SearchPath);
		if ПустаяСтрока(SearchPath) then
			raise "Не установлена переменная окружения %ASPCHome%"
		endif	
	Иначе 
		//возвращаем /opt/aspc/	- можно прмонтровать сетевую шару
		SearchPath="/opt/aspc";
		SysDelim = "/";
	конецесли;
	возврат SearchPath+"onesbin"+SysDelim+СтрЗаменить(Package,".",SysDelim)+SysDelim;
endfunction	
//Возвращает полный путь файла максимального релаза объекта
function GetMaxRel(package,libname,version)
	НайденныеФайлы=НайтиФайлы(SearchPath(Package),ObjFname(libname,version,"*","epf"),Ложь); 
	Если НайденныеФайлы.Количество()=0 Тогда
		result = "";	
	КонецЕсли;
	MaxRel=0; 
	Для К=0 По НайденныеФайлы.Количество()-1 Цикл
		Rel=Число(СтрПолучитьСтроку(СтрЗаменить(НайденныеФайлы[К].Имя,".",Символы.ПС),4));
		MaxRel=Макс(Rel,MaxRel);
	КонецЦикла;
	RelFile = New File(SearchPath(Package)+ObjFname(libname,version,Строка(MaxRel),"epf"));
	if RelFile.Существует() и RelFile.ЭтоФайл() тогда
		return RelFile.ПолноеИмя;
	else
		return "";
	endif;	
endfunction	
//Подключает библиотеки 
//package - имя пакета в который входит библиотека
//libname - имя библиотеки
//version - только версия как её возвращает функция Vrersion
//			будет загружен максимальный найденный релиз
//alias   - под этим именем будет зарегестритрованна внешняя обработка
//safemode- безопасный режим см. ВнешниеОбработкиМенеджер.Подключить
//PlatformVersion - для совместимости
procedure Include(package,libname,version,alias,safemode=false) export
	if libs=Неопределено then
		libs = Новый Структура;
	else
		if libs.Свойство(alias) then
			 raise _ExceptionConflictAliase(alias);
		endif	
    endif;
	ObjPath = GetMaxRel(package,libname,version);
	if ПустаяСтрока(ObjPath) then
	 	mess="
			  |Package    = "+Package+"
			  |Name       = "+libname+"
			  |Version    = "+version+"
			  |SearchPath = "+SearchPath(Package)+"
			  |ObjFname   = "+ObjFname(libname,version,"*","epf")+"
			  |";
		raise _ExceptionLostDependens(mess);
	else						
		libs.Вставить(alias,ВнешниеОбработки.Создать(ObjPath,safemode));
	endif	
endprocedure
//Документация по API
function Usage() export
return "TODO Это пример. Надо заполнять. Потом очень помогает.
|function ExecQuery()
|Descr:   
|Выполняет запрос на строне удаленной ИБ.
|
|ReturnType:  
|<ComOject>
|
|ReturnValue: 
|Результат запроса на стороне удалённой ИБ.
|
|Params:
|      QueryText      - <Строка> Обязательный. Текст запроса.
|      OnesConnection - <ComOject> Обязательный. Объект типа ""Внешнее Соединение"" или ""Automation сервер"" - соединение с удалённой ИБ.
|      QueryParam     - <Структура> Необязательный. Параметры запроса. QueryParam.Ключ - Имя параметра  QueryParam.Значение - значение параметра. Значения автоматически будут приведены к значениям удалённой ИБ. См. ToExternalValue()
|      
|Raise:
|      _ExceptionLocRefTypeNotExist
|      _ExceptionLocObjectNotExist
|Example:
|     qr =  ExecQuery(QueryText,Connector);
|     ТаблицаЗначений = UnloadQueryResult(qr,Connector);
|     Для Каждого Строка из ТаблицаЗначений Цикл
|     	//ДЧН
|     КонецЦикла
|
|Prototype:
|		 function ExecQuery(QueryText,OnesConnection,QueryParam)
|";
endfunction
//Отладка
function Debug() export
	//Если файл находится в SearchPath(Package)
	//значит это релиз и Debug = false
	F=Новый Файл(ЭтотОбъект.ИспользуемоеИмяФайла);
	if НРег(F.Путь)=НРег(SearchPath(Package())) then
		 return false;                                              
	else
		 return true;
	endif 
EndFunction
procedure Trace(mess) export
//Выводит сообщения если Debug=true
if Debug() then 
	Сообщить("trace: "+mess);
endif	
endprocedure	
//Заглушка для значений требующих обязательного заполнения
function raise_TODO(mess="")
	raise "TODO "+mess;	
endfunction	

//Стандартные исключения
function _ExceptionConflictAliase(mess="") export
	return "<ExceptionConflictAliase>"+mess;
endfunction	
function _ExceptionLostDependens(mess="") export
	return "<ExceptionLostDependens>"+mess;
endfunction	
function _ExceptionNotImpliment(mess="") export
	return "<ExceptionNotImpliment>"+mess;
endfunction
function _ExceptionBadParamType(PName,mess="")export
	return "<ExceptionBadParamType PName="""+PName+""">"+mess;
endfunction
function _ExceptionBadParamValue(PName,mess="")export
	return "<ExceptionBadParamValue PName="""+PName+""">"+mess;
endfunction

//ШАБЛОН АСПЦ-1С КОНЕЦ
////////////////////////////////////////////////////

////////////////////////////////////////////////////
//ИНТЕГРАЦИЯ С БСП

// Интерфейс для регистрации обработки.
// Вызывается при добавлении обработки в справочник "ВнешниеОбработки"
//
// Возвращаемое значение:
// Структура:
// Вид - строка - возможные значения:	"ДополнительнаяОбработка"
//										"ДополнительныйОтчет"
//										"ЗаполнениеОбъекта"
//										"Отчет"
//										"ПечатнаяФорма"
//										"СозданиеСвязанныхОбъектов"
//
// Назначение - массив строк имен объектов метаданных в формате:
//			<ИмяКлассаОбъектаМетаданного>.[ * | <ИмяОбъектаМетаданных>]
//			Например, "Документ.СчетЗаказ" или "Справочник.*"
//			Прим. параметр имеет смысл только для назначаемых обработок
//
// Наименование - строка - наименование обработки, которым будет заполнено
//						наименование справочника по умолчанию - краткая строка для
//						идентификации обработки администратором
//
// Версия - строка - версия обработки в формате <старший номер>.<младший номер>
//					используется при загрузке обработок в информационную базу
// БезопасныйРежим – Булево – Если истина, обработка будет запущена в безопасном режиме.
//							Более подбробная информация в справке.
//
// Информация - Строка- краткая информация по обработке, описание обработки
//
// Команды - ТаблицаЗначений - команды, поставляемые обработкой, одная строка таблицы соотвествует
//							одной команде
//				колонки: 
//				 - Представление - строка - представление команды конечному пользователю
//				 - Идентификатор - строка - идентефикатор команды. В случае печатных форм
//											перечисление через запятую списка макетов
//				 - Использование - строка - варианты запуска обработки:
//						"ОткрытиеФормы" - открыть форму обработки
//						"ВызовКлиентскогоМетода" - вызов клиентского экспортного метода из формы обработки
//						"ВызовСерверногоМетода" - вызов серверного экспортного метода из модуля объекта обработки
//				 - ПоказыватьОповещение – Булево – если Истина, требуется оказывать оповещение при начале
//								и при окончании запуска обработки. Прим. Имеет смысл только
//								при запуске обработки без открытия формы.
//				 - Модификатор – строка - для печатных форм MXL, которые требуется
//										отображать в форме ПечатьДокументов подсистемы Печать
//										требуется установить как "ПечатьMXL"
//
Функция СведенияОВнешнейОбработке() Экспорт
	ПараметрыРегистрации = Новый Структура;
	
	ПараметрыРегистрации.Вставить("Вид", raise_TODO());
	ПараметрыРегистрации.Вставить("Назначение",  raise_TODO());
	ПараметрыРегистрации.Вставить("Наименование", НСтр("ru = '"+ЭтотОбъект.Метаданные().Синоним+"'"));
	ПараметрыРегистрации.Вставить("Версия", Version());
	ПараметрыРегистрации.Вставить("БезопасныйРежим", raise_TODO());
	ПараметрыРегистрации.Вставить("Информация", НСтр("ru = '"+ЭтотОбъект.Метаданные().Комментарий+"'"));
	
	ТаблицаКоманд = ПолучитьТаблицуКоманд();
	//
	ДобавитьКоманду(ТаблицаКоманд,
					НСтр("ru = '"+raise_TODO()+"'"),
					Команда_ХХХ(),
					"ВызовСерверногоМетода",
					Истина);
	
	
	ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
	
	Возврат ПараметрыРегистрации;
КонецФункции

Функция ПолучитьТаблицуКоманд()
	
	Команды = Новый ТаблицаЗначений;
	Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка"));
	Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка"));
	Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка"));
	Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));
	Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
	
	Возврат Команды;
	
КонецФункции

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение = Ложь, Модификатор = "")
	НоваяКоманда = ТаблицаКоманд.Добавить();
	НоваяКоманда.Представление = Представление;
	НоваяКоманда.Идентификатор = Идентификатор;
	НоваяКоманда.Использование = Использование;
	НоваяКоманда.ПоказыватьОповещение = ПоказыватьОповещение;
	НоваяКоманда.Модификатор = Модификатор;
КонецПроцедуры
//Команды
Функция Команда_ХХХ() Экспорт
	Возврат raise_TODO();	
КонецФункции	
//ИНТЕГРАЦИЯ С БСП КОНЕЦ
////////////////////////////////////////////////////


////////////////////////////////////////////////////
// ИНТЕРФЕЙС БСП

// Интерфейс для запуска логики обработки
//Для глобальных отчетов и глобальных обработок –
//	Прототип: Процедура ВыполнитьКоманду(ИдентификаторКоманды,ПараметрыВыполненияКоманды) Экспорт
//  Параметры:
//     ПараметрыВыполненияКоманды – структура 
//        <ДополнительнаяОбработкаСсылка> - ссылка на элемент справочника ДополнительныеОтчетыИОбработки, который связан с данной дополнительной обработкой
//Для Для назначаемых обработок типа "Создание связанных объектов"
//	Прототип: Процедура ВыполнитьКоманду(ИдентификаторКоманды, ОбъектыНазначения, СозданныеОбъекты, ПараметрыВыполненияКоманды) Экспорт
//Для назначаемых обработок типа "Заполнение объекта" и других типов обработок
//  Прототип: Процедура ВыполнитьКоманду(ИдентификаторКоманды, ОбъектыНазначения,  ПараметрыВыполненияКоманды) Экспорт
Процедура ВыполнитьКоманду(ИдентификаторКоманды,ПараметрыВыполненияКоманды) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ИдентификаторКоманды = Команда_ХХХ() Тогда
		raise_TODO();
	КонецЕсли;
	
КонецПроцедуры

// Реализация логики команды печати
//Для назначаемых обработок типа «Печать» не на основе табличных документов
//  Прототип: Процедура Печать(ИдентификаторКоманды, ОбъектыНазначения) Экспорт
//Для назначаемых обработок типа «Печать» на основе табличных документов
//  Прототип: Процедура Печать(МассивОбъектов, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода) Экспорт
//  Параметры:
Процедура Печать(ИдентификаторКоманды, ОбъектыНазначенияМассив) Экспорт
  //...
КонецПроцедуры

// ИНТЕРФЕЙС БСП
////////////////////////////////////////////////////


//////////////////////////////////
//$START_MODULE{ КОД МОДУЛЯ НАЧАЛО


//{TODO КОД МОДУЛЯ ПИШЕМ ЗДЕСЬ}


//$END_MODULE} КОД МОДУЛЯ КОНЕЦ
///////////////////////////////

//ПОДКЛЮЧАЕМ БИБЛИОТЕКИ
//Include("package","libname","v1.v2","alias",true|false);                                           

//{TODO ПОДКЛЮЧАЕМ БИБЛИОТЕКИ ЗДЕСЬ}


////////////////////////////////////////////////////////////////////////////////////
//	 	ОСНОВНАЯ ПРОГРАММА МОДУЛЯ ПИШЕМ НИЖЕ

//{TODO ОСНОВНАЯ ПРОГРАММА МОДУЛЯ ПИШЕМ ЗДЕСЬ}

